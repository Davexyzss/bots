name: Notify Discord on Push

on:
  push:
    branches:
      - '**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send fancy embed to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          AUTHOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          AVATAR_URL="https://github.com/${AUTHOR}.png"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # L·∫•y danh s√°ch commit
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "- \(.message) [`\(.id[0:7])`](\(.url))"' | head -n 10)

          # Escape commit messages cho JSON (n·∫øu c·∫ßn)
          COMMITS_ESCAPED=$(echo "$COMMITS" | jq -Rs .)

          # T·∫°o JSON embed
          EMBED=$(cat <<EOF
          {
            "embeds": [
              {
                "title": "üöÄ New Push to $REPO",
                "url": "$COMMIT_URL",
                "color": 3447003,
                "author": {
                  "name": "$AUTHOR",
                  "icon_url": "$AVATAR_URL",
                  "url": "https://github.com/$AUTHOR"
                },
                "fields": [
                  {
                    "name": "üì¶ Branch",
                    "value": "$BRANCH",
                    "inline": true
                  },
                  {
                    "name": "üìù Commits",
                    "value": $COMMITS_ESCAPED
                  }
                ],
                "footer": {
                  "text": "GitHub Actions ‚Ä¢ $REPO"
                },
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
EOF
          )

          echo "$EMBED" | curl -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
