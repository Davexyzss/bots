name: Notify Discord on Push

on:
  push:
    branches:
      - '**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send embed to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          AUTHOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          AVATAR_URL="https://github.com/${AUTHOR}.png"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Get commit messages (limit to 5)
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "- \(.message | gsub("\""; "\\\"")) [`\(.id[0:7])`](\(.url))"' | head -n 5)

          # Escape commits for JSON
          COMMITS_ESCAPED=$(echo "$COMMITS" | jq -Rs .)

          # Build JSON
          JSON="{\"embeds\": [{
            \"title\": \"üöÄ New Push to $REPO\",
            \"url\": \"$COMMIT_URL\",
            \"color\": 3447003,
            \"author\": {
              \"name\": \"$AUTHOR\",
              \"icon_url\": \"$AVATAR_URL\",
              \"url\": \"https://github.com/$AUTHOR\"
            },
            \"fields\": [
              { \"name\": \"üì¶ Branch\", \"value\": \"\`$BRANCH\`\", \"inline\": true },
              { \"name\": \"üìù Commits\", \"value\": $COMMITS_ESCAPED }
            ],
            \"footer\": {
              \"text\": \"GitHub Actions ‚Ä¢ $REPO\"
            },
            \"timestamp\": \"$TIMESTAMP\"
          }]}"

          echo "$JSON" | curl -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
